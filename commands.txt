# OPTION 1: SIMPLE FIX (Only fixes the download endpoint issue)

# 1. Copy the simple fix script to the server
scp simple-fix.js root@104.245.241.185:/var/www/coveredamerican.com/audio/

# 2. SSH into the server
ssh root@104.245.241.185

# 3. Navigate to the application directory
cd /var/www/coveredamerican.com/audio

# 4. Run the simple fix script
node simple-fix.js

# 5. Restart the server
pm2 restart call-info-remover

# OPTION 2: COMPREHENSIVE FIX (Fixes all issues and adds enhanced logging)

# 1. Copy the necessary files to the server

# Create the necessary directories on the server
ssh root@104.245.241.185 "mkdir -p /var/www/coveredamerican.com/audio/db"

# Copy the fix scripts and diagnostic tools
scp fix-download-endpoint.js root@104.245.241.185:/var/www/coveredamerican.com/audio/
scp fix-db-module.js root@104.245.241.185:/var/www/coveredamerican.com/audio/
scp install-all-fixes.js root@104.245.241.185:/var/www/coveredamerican.com/audio/
scp diagnose-database.js root@104.245.241.185:/var/www/coveredamerican.com/audio/

# Copy the enhanced logging files
scp enhanced-logging.js root@104.245.241.185:/var/www/coveredamerican.com/audio/
scp db/enhanced-index.js root@104.245.241.185:/var/www/coveredamerican.com/audio/db/

# 2. SSH into the server
ssh root@104.245.241.185

# 3. Navigate to the application directory
cd /var/www/coveredamerican.com/audio

# 4. Run the combined installation script
node install-all-fixes.js

# 5. Create the original_audio table if it doesn't exist
# Connect to your PostgreSQL database (adjust username and database name as needed)
psql -U call_info_user -d call_info_remover

# Run this SQL command in the PostgreSQL prompt
CREATE TABLE IF NOT EXISTS original_audio (
  id SERIAL PRIMARY KEY,
  recording_id INTEGER REFERENCES recordings(id) ON DELETE CASCADE,
  content_type VARCHAR(255) NOT NULL,
  data TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

# Exit PostgreSQL
\q

# 6. Restart the server
pm2 restart call-info-remover

# OPTION 3: DIAGNOSTIC TOOLS (If you want to diagnose issues without applying fixes)

# 1. Copy the diagnostic tools to the server
scp diagnose-database.js root@104.245.241.185:/var/www/coveredamerican.com/audio/
scp validate-syntax.js root@104.245.241.185:/var/www/coveredamerican.com/audio/
scp check-server-file.js root@104.245.241.185:/var/www/coveredamerican.com/audio/

# 2. SSH into the server
ssh root@104.245.241.185

# 3. Navigate to the application directory
cd /var/www/coveredamerican.com/audio

# 4. Run the diagnostic tools
# Check for syntax errors
node validate-syntax.js server.js

# Check the server.js file in detail
node check-server-file.js server.js

# Check the database for a specific recording
node diagnose-database.js 2  # Replace 2 with the recording ID you're having issues with